<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>賞味期限管理（ボトルビール）</title>
  <style>
    :root { --pad: 14px; --r: 12px; }
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; margin:0; background:#f6f7f9; }
    header { position: sticky; top:0; background:white; border-bottom:1px solid #e7e7e7; padding:12px var(--pad); z-index:10; }
    header h1 { margin:0; font-size:18px; }
    main { padding: var(--pad); max-width: 900px; margin: 0 auto; }
    .card { background:white; border:1px solid #e7e7e7; border-radius: var(--r); padding: var(--pad); box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > * { flex: 1 1 160px; }
    label { display:block; font-size:12px; color:#555; margin:0 0 4px; }
    input, button, select { width:100%; box-sizing:border-box; padding:10px; border:1px solid #d9d9d9; border-radius:10px; font-size:15px; background:white; }
    button { cursor:pointer; border:1px solid #cfcfcf; background:#111; color:white; }
    button.secondary { background:#fff; color:#111; }
    button.danger { background:#b00020; border-color:#b00020; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .stack { display:flex; flex-direction:column; gap:10px; }
    .muted { color:#666; font-size:12px; }
    .hidden { display:none !important; }
    .list { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item { display:flex; gap:10px; align-items:flex-start; justify-content:space-between; border:1px solid #eee; border-radius:12px; padding:12px; }
    .item .left { min-width: 0; flex: 1; }
    .item .name { font-weight: 700; font-size:16px; margin:0 0 6px; word-break:break-word; }
    .item .meta { display:flex; gap:10px; flex-wrap:wrap; font-size:13px; color:#444; }
    .pill { padding:4px 8px; border-radius:999px; background:#f1f3f5; border:1px solid #e9ecef; }
    .warn { background:#fff4e6; border-color:#ffe0b2; }
    .bad { background:#ffe3e3; border-color:#ffb3b3; }
    .good { background:#e6fcf5; border-color:#b2f2e5; }
    .right { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .toast { position: fixed; left:50%; transform:translateX(-50%); bottom: 18px; background:#111; color:#fff; padding:10px 12px; border-radius: 999px; font-size: 13px; opacity:0; pointer-events:none; transition:opacity .15s ease; max-width: 92vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .toast.show { opacity: 1; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .topbar .who { font-size:12px; color:#666; word-break:break-all; }
    .hr { height:1px; background:#eee; margin:12px 0; }
    .help { font-size:12px; color:#666; line-height:1.6; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .kpi .box { border:1px solid #eee; border-radius:12px; padding:10px; background:#fafafa; min-width: 120px; }
    .kpi .n { font-size:18px; font-weight:800; }
    .kpi .t { font-size:12px; color:#666; }
    .status { font-size:12px; color:#666; padding:8px 10px; border:1px dashed #ddd; border-radius:12px; background:#fafafa; }
    @media (max-width:480px){
      header h1 { font-size:16px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <h1>賞味期限管理（ボトルビール）</h1>
      <div>
        <button id="btnLogout" class="secondary hidden" type="button">ログアウト</button>
      </div>
    </div>
    <div id="who" class="who muted"></div>
  </header>

  <main class="stack">
    <!-- 設定（ログイン後は非表示にする：誤動作防止） -->
    <section id="cfgCard" class="card">
      <div class="stack">
        <div class="help">
          <b>初期設定：</b>Supabaseの <b>Project URL</b> と <b>公開キー（sb_publishable_…）</b> を入れて保存 → ログイン。<br/>
          ※ログイン後はこの設定欄を非表示にします（誤操作防止）。
        </div>
        <div id="libStatus" class="status">ライブラリ状態: 確認中…</div>
        <div class="row">
          <div>
            <label>SUPABASE_URL</label>
            <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
          </div>
          <div>
            <label>SUPABASE_PUBLIC_KEY（sb_publishable_... / 旧 anon でも可）</label>
            <input id="sbKey" placeholder="sb_publishable_..." />
          </div>
          <div style="flex:0 0 140px;">
            <label>&nbsp;</label>
            <button id="btnSaveCfg" type="button" class="secondary">保存</button>
          </div>
        </div>
        <div class="muted">※端末ローカルに保存します（localStorage）。</div>
      </div>
    </section>

    <!-- ログイン -->
    <section id="authCard" class="card">
      <div class="stack">
        <h2 style="margin:0;font-size:16px;">ログイン</h2>
        <div class="row">
          <div>
            <label>メールアドレス</label>
            <input id="email" type="email" autocomplete="username" placeholder="staff@example.com" />
          </div>
          <div>
            <label>パスワード</label>
            <input id="password" type="password" autocomplete="current-password" placeholder="********" />
          </div>
          <div style="flex:0 0 160px;">
            <label>&nbsp;</label>
            <button id="btnLogin" type="button">ログイン</button>
          </div>
        </div>
        <div class="help">
          同一店舗運用で「全タブレット同一アカウント」想定。<br/>
          ※ユーザー未作成だとログインできません（Supabase Auth → Users で作成）。
        </div>
      </div>
    </section>

    <!-- アプリ本体 -->
    <section id="appCard" class="card hidden">
      <div class="stack">
        <div class="row" style="align-items:flex-end;">
          <div style="flex: 2 1 220px;">
            <label>商品名（ボトルビール）</label>
            <input id="inName" placeholder="例）Guinness / Pilsner / Lambic など" />
          </div>
          <div>
            <label>賞味期限</label>
            <input id="inExp" type="date" />
          </div>
          <div>
            <label>数量（0はNG）</label>
            <input id="inQty" type="number" inputmode="numeric" min="1" step="1" value="1" />
          </div>
          <div style="flex: 2 1 220px;">
            <label>保存場所</label>
            <select id="inLoc">
              <option value="">選択してね</option>
              <option value="ビアタップチャンバー">ビアタップチャンバー</option>
              <option value="イギリス">イギリス</option>
              <option value="チェコ">チェコ</option>
              <option value="ベルギー">ベルギー</option>
              <option value="チャンバー">チャンバー</option>
            </select>
          </div>
          <div style="flex:0 0 140px;">
            <label>&nbsp;</label>
            <button id="btnAdd" type="button">追加</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="align-items:flex-end;">
          <div>
            <label>検索（商品名 / 保存場所）</label>
            <input id="inSearch" placeholder="例）Guinness / ベルギー / チャンバー" />
          </div>
          <div style="flex:0 0 180px;">
            <label>並び順</label>
            <select id="selSort">
              <option value="exp_asc">賞味期限（近い→遠い）</option>
              <option value="exp_desc">賞味期限（遠い→近い）</option>
              <option value="created_desc">追加（新しい→古い）</option>
              <option value="created_asc">追加（古い→新しい）</option>
              <option value="name_asc">商品名（A→Z）</option>
              <option value="name_desc">商品名（Z→A）</option>
            </select>
          </div>
          <div style="flex:0 0 140px;">
            <label>&nbsp;</label>
            <button id="btnReload" type="button" class="secondary">再読込</button>
          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="n" id="kpiTotal">0</div>
            <div class="t">合計</div>
          </div>
          <div class="box">
            <div class="n" id="kpiSoon">0</div>
            <div class="t">3日以内</div>
          </div>
          <div class="box">
            <div class="n" id="kpiExpired">0</div>
            <div class="t">期限切れ</div>
          </div>
        </div>

        <div id="list" class="list"></div>
        <div id="empty" class="muted" style="margin-top:8px;">データがありません。</div>

        <div class="help">
          <b>同期：</b>別のiPadで追加/更新/削除すると、この画面も自動更新します（Realtime）。<br/>
          <b>保存場所：</b>VerBでは DBの <code>note</code> に保存場所を入れてます（UI上は保存場所として表示）。
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- ✅ Supabase JS (UMDの正しいパス) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // ==========
    // VerB: ボトルビール + 保存場所 + 設定欄ログイン後非表示
    // 保存場所はDBの note カラムに保存（DB変更なしでまず動かす）
    // ==========

    const LS_URL_KEY = "sb_url";
    const LS_ANON_KEY = "sb_anon";
    const $ = (id) => document.getElementById(id);

    const LOCATIONS = ["ビアタップチャンバー","イギリス","チェコ","ベルギー","チャンバー"];

    let supabaseClient = null;
    let realtimeChannel = null;
    let itemsCache = [];

    function toast(msg) {
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 2200);
    }

    // どこで落ちても画面に出す（「無反応」対策）
    window.addEventListener("error", (e) => {
      toast(`JSエラー: ${e.message}`);
      console.error(e.error || e);
    });
    window.addEventListener("unhandledrejection", (e) => {
      toast(`Promiseエラー: ${e.reason?.message || e.reason}`);
      console.error(e.reason);
    });

    function setLibStatus() {
      const ok = !!(window.supabase && typeof window.supabase.createClient === "function");
      $("libStatus").textContent = ok
        ? "ライブラリ状態: OK（supabase-js 読み込み成功）"
        : "ライブラリ状態: NG（supabase-js 読み込み失敗）→ ネットワーク/拡張機能/URLを確認";
    }

    function formatDateYMD(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function daysDiffFromToday(dateStr) {
      const today = new Date();
      const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const parts = dateStr.split("-").map(Number);
      const d = new Date(parts[0], parts[1] - 1, parts[2]);
      const ms = d.getTime() - t0.getTime();
      return Math.round(ms / (1000 * 60 * 60 * 24));
    }

    function badgeClass(diff) {
      if (diff < 0) return "bad";
      if (diff <= 3) return "warn";
      return "good";
    }

    function normalizeLocationFromRow(row) {
      // VerBでは note を「保存場所」として扱う
      const v = (row?.note || "").trim();
      return LOCATIONS.includes(v) ? v : "";
    }

    function ensureSupabase() {
      setLibStatus();
      if (!(window.supabase && typeof window.supabase.createClient === "function")) {
        toast("supabase-js が読み込めてません（libStatusを確認）");
        return null;
      }

      const url = $("sbUrl").value.trim();
      const key = $("sbKey").value.trim();
      if (!url || !key) {
        toast("Supabase URL / 公開キーを設定してね");
        return null;
      }

      if (!supabaseClient) {
        supabaseClient = window.supabase.createClient(url, key);
      }
      return supabaseClient;
    }

    function loadCfgFromLS() {
      $("sbUrl").value = localStorage.getItem(LS_URL_KEY) || "";
      $("sbKey").value = localStorage.getItem(LS_ANON_KEY) || "";
    }

    function saveCfgToLS() {
      localStorage.setItem(LS_URL_KEY, $("sbUrl").value.trim());
      localStorage.setItem(LS_ANON_KEY, $("sbKey").value.trim());
      toast("設定を保存しました");
      supabaseClient = null; // 作り直し
    }

    // ==========
    // Auth
    // ==========
    async function refreshSessionUI() {
      const sb = ensureSupabase();
      if (!sb) return;

      const { data: { session } } = await sb.auth.getSession();
      const loggedIn = !!session;

      $("authCard").classList.toggle("hidden", loggedIn);
      $("appCard").classList.toggle("hidden", !loggedIn);
      $("btnLogout").classList.toggle("hidden", !loggedIn);

      // ✅ ログイン後は設定欄を隠す（誤操作防止）
      $("cfgCard").classList.toggle("hidden", loggedIn);

      $("who").textContent = loggedIn ? `ログイン中: ${session.user.email}` : "";

      if (loggedIn) {
        await startRealtime();
        await reloadItems(false);
      } else {
        await stopRealtime();
        itemsCache = [];
        render();
      }
    }

    async function login() {
      toast("ログイン処理開始…");
      const sb = ensureSupabase();
      if (!sb) return;

      const email = $("email").value.trim();
      const password = $("password").value;

      if (!email || !password) {
        toast("メールとパスワードを入力してね");
        return;
      }

      $("btnLogin").disabled = true;
      try {
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        toast("ログインしました");
        await refreshSessionUI();
      } catch (e) {
        console.error(e);
        toast(`ログイン失敗: ${e.message || e}`);
      } finally {
        $("btnLogin").disabled = false;
      }
    }

    async function logout() {
      const sb = ensureSupabase();
      if (!sb) return;
      await sb.auth.signOut();
      toast("ログアウトしました");
      await refreshSessionUI();
    }

    // ==========
    // Realtime
    // ==========
    async function startRealtime() {
      const sb = ensureSupabase();
      if (!sb) return;
      if (realtimeChannel) return;

      realtimeChannel = sb
        .channel("rt-items")
        .on("postgres_changes",
          { event: "*", schema: "public", table: "items" },
          async () => {
            await reloadItems(false);
            toast("同期更新");
          }
        )
        .subscribe();
    }

    async function stopRealtime() {
      const sb = ensureSupabase();
      if (!sb) return;
      if (realtimeChannel) {
        await sb.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
    }

    // ==========
    // CRUD
    // ==========
    function getSortSpec() {
      const v = $("selSort").value;
      if (v === "exp_asc") return { col: "expiration_date", asc: true };
      if (v === "exp_desc") return { col: "expiration_date", asc: false };
      if (v === "created_asc") return { col: "created_at", asc: true };
      if (v === "created_desc") return { col: "created_at", asc: false };
      if (v === "name_asc") return { col: "name", asc: true };
      if (v === "name_desc") return { col: "name", asc: false };
      return { col: "expiration_date", asc: true };
    }

    async function reloadItems(showToast = true) {
      const sb = ensureSupabase();
      if (!sb) return;
      const sort = getSortSpec();

      $("btnReload").disabled = true;
      try {
        const { data, error } = await sb
          .from("items")
          .select("*")
          .order(sort.col, { ascending: sort.asc });

        if (error) throw error;
        itemsCache = data || [];
        render();
        if (showToast) toast("読み込みました");
      } catch (e) {
        console.error(e);
        toast(`読込失敗: ${e.message || e}`);
      } finally {
        $("btnReload").disabled = false;
      }
    }

    async function addItem() {
      const sb = ensureSupabase();
      if (!sb) return;

      const name = $("inName").value.trim();
      const exp = $("inExp").value;
      const qtyRaw = $("inQty").value;
      const qty = parseInt(qtyRaw, 10);
      const loc = $("inLoc").value.trim();

      if (!name) return toast("商品名を入力してね");
      if (!exp) return toast("賞味期限を選んでね");
      if (!Number.isFinite(qty) || qty < 1) return toast("数量は1以上（0はNG）");
      if (!loc) return toast("保存場所を選んでね");

      $("btnAdd").disabled = true;
      try {
        // 保存場所は note に入れる（DB変更なしの暫定）
        const { error } = await sb
          .from("items")
          .insert([{
            name,
            expiration_date: exp,
            quantity: qty,
            note: loc
          }]);

        if (error) throw error;

        $("inName").value = "";
        $("inExp").value = formatDateYMD(new Date());
        $("inQty").value = "1";
        $("inLoc").value = "";
        toast("追加しました");
        await reloadItems(false);
      } catch (e) {
        console.error(e);
        toast(`追加失敗: ${e.message || e}`);
      } finally {
        $("btnAdd").disabled = false;
      }
    }

    async function updateItem(id, patch) {
      const sb = ensureSupabase();
      if (!sb) return;
      try {
        const { error } = await sb.from("items").update(patch).eq("id", id);
        if (error) throw error;
        toast("更新しました");
        await reloadItems(false);
      } catch (e) {
        console.error(e);
        toast(`更新失敗: ${e.message || e}`);
      }
    }

    async function deleteItem(id) {
      const sb = ensureSupabase();
      if (!sb) return;
      if (!confirm("削除しますか？")) return;
      try {
        const { error } = await sb.from("items").delete().eq("id", id);
        if (error) throw error;
        toast("削除しました");
        await reloadItems(false);
      } catch (e) {
        console.error(e);
        toast(`削除失敗: ${e.message || e}`);
      }
    }

    // ==========
    // Render
    // ==========
    function filteredItems() {
      const q = $("inSearch").value.trim().toLowerCase();
      if (!q) return itemsCache;

      return itemsCache.filter(it => {
        const a = (it.name || "").toLowerCase();
        const loc = normalizeLocationFromRow(it).toLowerCase();
        return a.includes(q) || loc.includes(q);
      });
    }

    function renderKpi(list) {
      $("kpiTotal").textContent = String(list.length);
      let soon = 0;
      let expired = 0;
      for (const it of list) {
        const d = daysDiffFromToday(it.expiration_date);
        if (d < 0) expired++;
        if (d >= 0 && d <= 3) soon++;
      }
      $("kpiSoon").textContent = String(soon);
      $("kpiExpired").textContent = String(expired);
    }

    function render() {
      const listEl = $("list");
      listEl.innerHTML = "";

      const list = filteredItems();
      renderKpi(list);
      $("empty").style.display = list.length ? "none" : "block";

      for (const it of list) {
        const diff = daysDiffFromToday(it.expiration_date);
        const cls = badgeClass(diff);
        const loc = normalizeLocationFromRow(it) || "（未設定）";

        const card = document.createElement("div");
        card.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = it.name;

        const meta = document.createElement("div");
        meta.className = "meta";

        const pLoc = document.createElement("div");
        pLoc.className = "pill";
        pLoc.textContent = `保存場所: ${loc}`;

        const p1 = document.createElement("div");
        p1.className = `pill ${cls}`;
        p1.textContent = `賞味期限: ${it.expiration_date}`;

        const p2 = document.createElement("div");
        p2.className = "pill";
        if (diff < 0) p2.textContent = `${Math.abs(diff)}日 期限切れ`;
        else if (diff === 0) p2.textContent = "今日まで";
        else p2.textContent = `あと${diff}日`;

        const p3 = document.createElement("div");
        p3.className = "pill";
        p3.textContent = `数量: ${it.quantity}`;

        meta.appendChild(pLoc);
        meta.appendChild(p1);
        meta.appendChild(p2);
        meta.appendChild(p3);

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "right";

        const btnEdit = document.createElement("button");
        btnEdit.type = "button";
        btnEdit.className = "secondary";
        btnEdit.textContent = "編集";
        btnEdit.onclick = () => {
          const newName = prompt("商品名", it.name);
          if (newName === null) return;

          const newExp = prompt("賞味期限（YYYY-MM-DD）", it.expiration_date);
          if (newExp === null) return;

          const newQty = prompt("数量（0はNG）", String(it.quantity));
          if (newQty === null) return;

          const curLoc = normalizeLocationFromRow(it);
          const newLoc = prompt("保存場所（下からコピペ）\n- ビアタップチャンバー\n- イギリス\n- チェコ\n- ベルギー\n- チャンバー", curLoc || "");
          if (newLoc === null) return;

          const qtyInt = parseInt(newQty, 10);
          const locTrim = (newLoc || "").trim();

          if (!newName.trim()) return toast("商品名が空です");
          if (!/^\d{4}-\d{2}-\d{2}$/.test(newExp.trim())) return toast("賞味期限形式が違います");
          if (!Number.isFinite(qtyInt) || qtyInt < 1) return toast("数量は1以上（0はNG）");
          if (!LOCATIONS.includes(locTrim)) return toast("保存場所が指定の5種ではありません");

          updateItem(it.id, {
            name: newName.trim(),
            expiration_date: newExp.trim(),
            quantity: qtyInt,
            note: locTrim
          });
        };

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "danger";
        btnDel.textContent = "削除";
        btnDel.onclick = () => deleteItem(it.id);

        right.appendChild(btnEdit);
        right.appendChild(btnDel);

        card.appendChild(left);
        card.appendChild(right);

        listEl.appendChild(card);
      }
    }

    // ==========
    // Events / Init
    // ==========
    $("btnSaveCfg").addEventListener("click", () => {
      saveCfgToLS();
      refreshSessionUI();
    });

    $("btnLogin").addEventListener("click", login);
    $("btnLogout").addEventListener("click", logout);
    $("btnAdd").addEventListener("click", addItem);
    $("btnReload").addEventListener("click", () => reloadItems(true));
    $("selSort").addEventListener("change", () => reloadItems(false));
    $("inSearch").addEventListener("input", render);

    $("password").addEventListener("keydown", (e) => {
      if (e.key === "Enter") login();
    });

    $("inExp").value = formatDateYMD(new Date());

    // 起動
    loadCfgFromLS();
    setLibStatus();

    (async () => {
      if (($("sbUrl").value || "").trim() && ($("sbKey").value || "").trim()) {
        ensureSupabase();
      }
      try {
        await refreshSessionUI();
      } catch (e) {
        console.error(e);
        toast(`初期化失敗: ${e.message || e}`);
      }

      const sb = ensureSupabase();
      if (sb) {
        sb.auth.onAuthStateChange(async () => {
          await refreshSessionUI();
        });
      }
    })();
  </script>
</body>
</html>
