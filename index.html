<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>賞味期限管理（ボトルビール）</title>
  <style>
    :root { --pad: 14px; --r: 12px; --shadow: 0 1px 0 rgba(0,0,0,0.02); }
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; margin:0; background:#f6f7f9; }
    header { position: sticky; top:0; background:white; border-bottom:1px solid #e7e7e7; padding:12px var(--pad); z-index:10; }
    header h1 { margin:0; font-size:18px; }
    main { padding: var(--pad); max-width: 980px; margin: 0 auto; }
    .card { background:white; border:1px solid #e7e7e7; border-radius: var(--r); padding: var(--pad); box-shadow: var(--shadow); }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > * { flex: 1 1 160px; }
    label { display:block; font-size:12px; color:#555; margin:0 0 4px; }
    input, button, select { width:100%; box-sizing:border-box; padding:10px; border:1px solid #d9d9d9; border-radius:10px; font-size:15px; background:white; }
    button { cursor:pointer; border:1px solid #cfcfcf; background:#111; color:white; }
    button.secondary { background:#fff; color:#111; }
    button.danger { background:#b00020; border-color:#b00020; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .stack { display:flex; flex-direction:column; gap:10px; }
    .muted { color:#666; font-size:12px; }
    .hidden { display:none !important; }
    .list { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item { display:flex; gap:12px; align-items:flex-start; justify-content:space-between; border:1px solid #eee; border-radius:14px; padding:12px; background:#fff; }
    .item .left { min-width: 0; flex: 1; }
    .item .name { font-weight: 800; font-size:16px; margin:0 0 6px; word-break:break-word; }
    .item .meta { display:flex; gap:8px; flex-wrap:wrap; font-size:13px; color:#444; }
    .pill { padding:5px 9px; border-radius:999px; background:#f1f3f5; border:1px solid #e9ecef; }
    .warn { background:#fff4e6; border-color:#ffe0b2; }
    .bad { background:#ffe3e3; border-color:#ffb3b3; }
    .good { background:#e6fcf5; border-color:#b2f2e5; }
    .right { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:flex-start; }
    .toast { position: fixed; left:50%; transform:translateX(-50%); bottom: 18px; background:#111; color:#fff; padding:10px 12px; border-radius: 999px; font-size: 13px; opacity:0; pointer-events:none; transition:opacity .15s ease; max-width: 92vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .toast.show { opacity: 1; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .topbar .who { font-size:12px; color:#666; word-break:break-all; }
    .hr { height:1px; background:#eee; margin:12px 0; }
    .help { font-size:12px; color:#666; line-height:1.6; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .kpi .box { border:1px solid #eee; border-radius:14px; padding:10px; background:#fafafa; min-width: 120px; }
    .kpi .n { font-size:18px; font-weight:900; }
    .kpi .t { font-size:12px; color:#666; }
    .status { font-size:12px; color:#666; padding:8px 10px; border:1px dashed #ddd; border-radius:12px; background:#fafafa; }

    /* Tabs */
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab {
      width:auto;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      color:#111;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active {
      background:#111;
      color:#fff;
      border-color:#111;
    }

    /* Quantity stepper */
    .stepper { display:flex; align-items:center; gap:6px; }
    .stepper button {
      width:auto;
      padding:8px 10px;
      border-radius:12px;
      background:#fff;
      color:#111;
    }
    .stepper .qty {
      min-width: 44px;
      text-align:center;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:12px;
      background:#fafafa;
      font-weight:800;
    }

    /* Modal */
    .modalBackdrop {
      position: fixed; inset:0; background: rgba(0,0,0,0.35);
      display:none; align-items:center; justify-content:center; padding: 18px;
      z-index: 9999;
    }
    .modalBackdrop.show { display:flex; }
    .modal {
      width: min(720px, 100%);
      background:#fff;
      border-radius: 16px;
      border: 1px solid #e7e7e7;
      box-shadow: 0 16px 48px rgba(0,0,0,0.18);
      padding: 14px;
    }
    .modal h3 { margin: 6px 0 10px; font-size: 16px; }
    .modal .actions { display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top: 10px; }
    .modal .actions button { width:auto; }
    .modal .actions .danger { color:#fff; }
    .modal .actions .secondary { color:#111; }

    @media (max-width:480px){
      header h1 { font-size:16px; }
      .item { flex-direction:column; }
      .right { justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <h1>賞味期限管理（ボトルビール）</h1>
      <div>
        <button id="btnLogout" class="secondary hidden" type="button">ログアウト</button>
      </div>
    </div>
    <div id="who" class="who muted"></div>
  </header>

  <main class="stack">
    <!-- 設定（ログイン後は非表示） -->
    <section id="cfgCard" class="card">
      <div class="stack">
        <div class="help">
          <b>初期設定：</b>Supabaseの <b>Project URL</b> と <b>公開キー（sb_publishable_…）</b> を入れて保存 → ログイン。<br/>
          ※ログイン後はこの設定欄を非表示にします（誤操作防止）。
        </div>
        <div id="libStatus" class="status">ライブラリ状態: 確認中…</div>
        <div class="row">
          <div>
            <label>SUPABASE_URL</label>
            <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
          </div>
          <div>
            <label>SUPABASE_PUBLIC_KEY（sb_publishable_... / 旧 anon でも可）</label>
            <input id="sbKey" placeholder="sb_publishable_..." />
          </div>
          <div style="flex:0 0 140px;">
            <label>&nbsp;</label>
            <button id="btnSaveCfg" type="button" class="secondary">保存</button>
          </div>
        </div>
        <div class="muted">※端末ローカルに保存します（localStorage）。</div>
      </div>
    </section>

    <!-- ログイン -->
    <section id="authCard" class="card">
      <div class="stack">
        <h2 style="margin:0;font-size:16px;">ログイン</h2>
        <div class="row">
          <div>
            <label>メールアドレス</label>
            <input id="email" type="email" autocomplete="username" placeholder="staff@example.com" />
          </div>
          <div>
            <label>パスワード</label>
            <input id="password" type="password" autocomplete="current-password" placeholder="********" />
          </div>
          <div style="flex:0 0 160px;">
            <label>&nbsp;</label>
            <button id="btnLogin" type="button">ログイン</button>
          </div>
        </div>
        <div class="help">
          同一店舗運用で「全タブレット同一アカウント」想定。<br/>
          ※ユーザー未作成だとログインできません（Supabase Auth → Users で作成）。
        </div>
      </div>
    </section>

    <!-- アプリ本体 -->
    <section id="appCard" class="card hidden">
      <div class="stack">
        <!-- 保存場所タブ -->
        <div class="stack">
          <div class="muted">保存場所で絞り込み</div>
          <div id="tabs" class="tabs"></div>
        </div>

        <!-- 追加フォーム（必須だけ） -->
        <div class="row" style="align-items:flex-end;">
          <div style="flex: 2 1 240px;">
            <label>商品名（必須）</label>
            <input id="inName" placeholder="例）Guinness / Pilsner / Lambic など" />
          </div>
          <div>
            <label>賞味期限（必須）</label>
            <input id="inExp" type="date" />
          </div>
          <div style="flex: 1 1 160px;">
            <label>数量（必須 / 0はNG）</label>
            <input id="inQty" type="number" inputmode="numeric" min="1" step="1" value="1" />
          </div>
          <div style="flex: 2 1 220px;">
            <label>保存場所（必須）</label>
            <select id="inLoc">
              <option value="">選択してね</option>
              <option value="ビアタップチャンバー">ビアタップチャンバー</option>
              <option value="イギリス">イギリス</option>
              <option value="チェコ">チェコ</option>
              <option value="ベルギー">ベルギー</option>
              <option value="チャンバー">チャンバー</option>
            </select>
          </div>
          <div style="flex:0 0 140px;">
            <label>&nbsp;</label>
            <button id="btnAdd" type="button">追加</button>
          </div>
        </div>

        <div class="hr"></div>

        <!-- 検索＆並び -->
        <div class="row" style="align-items:flex-end;">
          <div>
            <label>検索（商品名）</label>
            <input id="inSearch" placeholder="例）Guinness / Pilsner" />
          </div>
          <div style="flex:0 0 220px;">
            <label>並び順</label>
            <select id="selSort">
              <option value="exp_practice">おすすめ（期限切れ→近い→遠い）</option>
              <option value="exp_asc">賞味期限（近い→遠い）</option>
              <option value="exp_desc">賞味期限（遠い→近い）</option>
              <option value="created_desc">追加（新しい→古い）</option>
              <option value="created_asc">追加（古い→新しい）</option>
              <option value="name_asc">商品名（A→Z）</option>
              <option value="name_desc">商品名（Z→A）</option>
            </select>
          </div>
          <div style="flex:0 0 140px;">
            <label>&nbsp;</label>
            <button id="btnReload" type="button" class="secondary">再読込</button>
          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="n" id="kpiTotal">0</div>
            <div class="t">合計</div>
          </div>
          <div class="box">
            <div class="n" id="kpiSoon">0</div>
            <div class="t">3日以内</div>
          </div>
          <div class="box">
            <div class="n" id="kpiExpired">0</div>
            <div class="t">期限切れ</div>
          </div>
        </div>

        <div id="list" class="list"></div>
        <div id="empty" class="muted" style="margin-top:8px;">データがありません。</div>

        <div class="help">
          <b>操作：</b>数量は「＋/－」で素早く変更、詳細変更は「編集」。<br/>
          <b>同期：</b>別のiPadで追加/更新/削除すると、この画面も自動更新します（Realtime）。<br/>
          <b>注意：</b>VerCでは保存場所をDBの <code>note</code> に保存しています（DB変更なしでまずテスト）。
        </div>
      </div>
    </section>
  </main>

  <!-- Modal（編集） -->
  <div id="modalBackdrop" class="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3>編集</h3>
      <div class="row">
        <div style="flex: 2 1 240px;">
          <label>商品名（必須）</label>
          <input id="mName" />
        </div>
        <div>
          <label>賞味期限（必須）</label>
          <input id="mExp" type="date" />
        </div>
        <div>
          <label>数量（必須 / 0はNG）</label>
          <input id="mQty" type="number" min="1" step="1" inputmode="numeric" />
        </div>
        <div style="flex: 2 1 220px;">
          <label>保存場所（必須）</label>
          <select id="mLoc">
            <option value="">選択してね</option>
            <option value="ビアタップチャンバー">ビアタップチャンバー</option>
            <option value="イギリス">イギリス</option>
            <option value="チェコ">チェコ</option>
            <option value="ベルギー">ベルギー</option>
            <option value="チャンバー">チャンバー</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="mCancel" type="button" class="secondary">キャンセル</button>
        <button id="mSave" type="button">保存</button>
        <button id="mDelete" type="button" class="danger">削除</button>
      </div>
      <div class="muted" id="mHint" style="margin-top:8px;"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ✅ Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // ==========
    // VerC: アプリ部分ブラッシュアップ（タブ / モーダル / 数量＋－ / 現場向けソート）
    // 保存場所はDBの note に保存（DB変更なし）
    // ==========

    const LS_URL_KEY = "sb_url";
    const LS_ANON_KEY = "sb_anon";
    const $ = (id) => document.getElementById(id);

    const LOCATIONS = ["ビアタップチャンバー","イギリス","チェコ","ベルギー","チャンバー"];
    const TAB_ALL = "__ALL__";

    let supabaseClient = null;
    let realtimeChannel = null;
    let itemsCache = [];
    let activeLoc = TAB_ALL;

    // modal state
    let modalOpen = false;
    let editingId = null;

    function toast(msg) {
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 2200);
    }

    window.addEventListener("error", (e) => {
      toast(`JSエラー: ${e.message}`);
      console.error(e.error || e);
    });
    window.addEventListener("unhandledrejection", (e) => {
      toast(`Promiseエラー: ${e.reason?.message || e.reason}`);
      console.error(e.reason);
    });

    function setLibStatus() {
      const ok = !!(window.supabase && typeof window.supabase.createClient === "function");
      $("libStatus").textContent = ok
        ? "ライブラリ状態: OK（supabase-js 読み込み成功）"
        : "ライブラリ状態: NG（supabase-js 読み込み失敗）→ ネットワーク/拡張機能/URLを確認";
    }

    function formatDateYMD(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function daysDiffFromToday(dateStr) {
      const today = new Date();
      const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const parts = dateStr.split("-").map(Number);
      const d = new Date(parts[0], parts[1] - 1, parts[2]);
      const ms = d.getTime() - t0.getTime();
      return Math.round(ms / (1000 * 60 * 60 * 24));
    }

    function badgeClass(diff) {
      if (diff < 0) return "bad";
      if (diff <= 3) return "warn";
      return "good";
    }

    function normalizeLocationFromRow(row) {
      const v = (row?.note || "").trim();
      return LOCATIONS.includes(v) ? v : "";
    }

    function ensureSupabase() {
      setLibStatus();
      if (!(window.supabase && typeof window.supabase.createClient === "function")) {
        toast("supabase-js が読み込めてません（libStatusを確認）");
        return null;
      }

      const url = $("sbUrl").value.trim();
      const key = $("sbKey").value.trim();
      if (!url || !key) {
        toast("Supabase URL / 公開キーを設定してね");
        return null;
      }

      if (!supabaseClient) {
        supabaseClient = window.supabase.createClient(url, key);
      }
      return supabaseClient;
    }

    function loadCfgFromLS() {
      $("sbUrl").value = localStorage.getItem(LS_URL_KEY) || "";
      $("sbKey").value = localStorage.getItem(LS_ANON_KEY) || "";
    }

    function saveCfgToLS() {
      localStorage.setItem(LS_URL_KEY, $("sbUrl").value.trim());
      localStorage.setItem(LS_ANON_KEY, $("sbKey").value.trim());
      toast("設定を保存しました");
      supabaseClient = null;
    }

    // ==========
    // Tabs
    // ==========
    function buildTabs() {
      const wrap = $("tabs");
      wrap.innerHTML = "";

      const makeTab = (label, value) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "tab" + (activeLoc === value ? " active" : "");
        b.textContent = label;
        b.onclick = () => {
          activeLoc = value;
          buildTabs();
          render();
        };
        return b;
      };

      wrap.appendChild(makeTab("全件", TAB_ALL));
      for (const loc of LOCATIONS) wrap.appendChild(makeTab(loc, loc));
    }

    // ==========
    // Auth
    // ==========
    async function refreshSessionUI() {
      const sb = ensureSupabase();
      if (!sb) return;

      const { data: { session } } = await sb.auth.getSession();
      const loggedIn = !!session;

      $("authCard").classList.toggle("hidden", loggedIn);
      $("appCard").classList.toggle("hidden", !loggedIn);
      $("btnLogout").classList.toggle("hidden", !loggedIn);
      $("cfgCard").classList.toggle("hidden", loggedIn);

      $("who").textContent = loggedIn ? `ログイン中: ${session.user.email}` : "";

      if (loggedIn) {
        buildTabs();
        await startRealtime();
        await reloadItems(false);
      } else {
        await stopRealtime();
        itemsCache = [];
        render();
      }
    }

    async function login() {
      toast("ログイン処理開始…");
      const sb = ensureSupabase();
      if (!sb) return;

      const email = $("email").value.trim();
      const password = $("password").value;

      if (!email || !password) return toast("メールとパスワードを入力してね");

      $("btnLogin").disabled = true;
      try {
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        toast("ログインしました");
        await refreshSessionUI();
      } catch (e) {
        console.error(e);
        toast(`ログイン失敗: ${e.message || e}`);
      } finally {
        $("btnLogin").disabled = false;
      }
    }

    async function logout() {
      const sb = ensureSupabase();
      if (!sb) return;
      await sb.auth.signOut();
      toast("ログアウトしました");
      await refreshSessionUI();
    }

    // ==========
    // Realtime
    // ==========
    async function startRealtime() {
      const sb = ensureSupabase();
      if (!sb) return;
      if (realtimeChannel) return;

      realtimeChannel = sb
        .channel("rt-items")
        .on("postgres_changes", { event: "*", schema: "public", table: "items" }, async () => {
          await reloadItems(false);
        })
        .subscribe();
    }

    async function stopRealtime() {
      const sb = ensureSupabase();
      if (!sb) return;
      if (realtimeChannel) {
        await sb.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
    }

    // ==========
    // CRUD
    // ==========
    function getSortSpec() {
      const v = $("selSort").value;
      if (v === "exp_asc") return { kind: "db", col: "expiration_date", asc: true };
      if (v === "exp_desc") return { kind: "db", col: "expiration_date", asc: false };
      if (v === "created_asc") return { kind: "db", col: "created_at", asc: true };
      if (v === "created_desc") return { kind: "db", col: "created_at", asc: false };
      if (v === "name_asc") return { kind: "db", col: "name", asc: true };
      if (v === "name_desc") return { kind: "db", col: "name", asc: false };
      // exp_practice は取得後にJSで“現場向け”整列
      return { kind: "practice" };
    }

    function sortPractice(list) {
      // 期限切れ(負)が先、その後は残日数が小さい順（近い順）
      // 同率なら保存場所→商品名
      return [...list].sort((a,b) => {
        const da = daysDiffFromToday(a.expiration_date);
        const db = daysDiffFromToday(b.expiration_date);
        if (da !== db) return da - db;
        const la = normalizeLocationFromRow(a) || "";
        const lb = normalizeLocationFromRow(b) || "";
        if (la !== lb) return la.localeCompare(lb, "ja");
        return (a.name || "").localeCompare((b.name || ""), "ja");
      });
    }

    async function reloadItems(showToast = true) {
      const sb = ensureSupabase();
      if (!sb) return;

      const sort = getSortSpec();
      $("btnReload").disabled = true;

      try {
        let q = sb.from("items").select("*");

        // DB側ソートできるものはDBで
        if (sort.kind === "db") {
          q = q.order(sort.col, { ascending: sort.asc });
        } else {
          // practiceの場合はとりあえず期限日昇順で取って、JSで整列
          q = q.order("expiration_date", { ascending: true });
        }

        const { data, error } = await q;
        if (error) throw error;

        itemsCache = data || [];
        render();
        if (showToast) toast("読み込みました");
      } catch (e) {
        console.error(e);
        toast(`読込失敗: ${e.message || e}`);
      } finally {
        $("btnReload").disabled = false;
      }
    }

    function validateItem(name, exp, qty, loc) {
      if (!name) return "商品名を入力してね";
      if (!exp) return "賞味期限を選んでね";
      if (!Number.isFinite(qty) || qty < 1) return "数量は1以上（0はNG）";
      if (!loc) return "保存場所を選んでね";
      if (!LOCATIONS.includes(loc)) return "保存場所が不正です";
      return "";
    }

    async function addItem() {
      const sb = ensureSupabase();
      if (!sb) return;

      const name = $("inName").value.trim();
      const exp = $("inExp").value;
      const qty = parseInt($("inQty").value, 10);
      const loc = $("inLoc").value.trim();

      const msg = validateItem(name, exp, qty, loc);
      if (msg) return toast(msg);

      $("btnAdd").disabled = true;
      try {
        const { error } = await sb.from("items").insert([{
          name,
          expiration_date: exp,
          quantity: qty,
          note: loc
        }]);
        if (error) throw error;

        // 次の入力を速く
        $("inName").value = "";
        $("inExp").value = formatDateYMD(new Date());
        $("inQty").value = "1";
        // 保存場所は“連続入力”のため保持（消さない）
        toast("追加しました");
        await reloadItems(false);
      } catch (e) {
        console.error(e);
        toast(`追加失敗: ${e.message || e}`);
      } finally {
        $("btnAdd").disabled = false;
      }
    }

    async function updateItem(id, patch, quiet=false) {
      const sb = ensureSupabase();
      if (!sb) return;
      try {
        const { error } = await sb.from("items").update(patch).eq("id", id);
        if (error) throw error;
        if (!quiet) toast("更新しました");
        await reloadItems(false);
      } catch (e) {
        console.error(e);
        toast(`更新失敗: ${e.message || e}`);
      }
    }

    async function deleteItem(id) {
      const sb = ensureSupabase();
      if (!sb) return;
      if (!confirm("削除しますか？")) return;
      try {
        const { error } = await sb.from("items").delete().eq("id", id);
        if (error) throw error;
        toast("削除しました");
        closeModal();
        await reloadItems(false);
      } catch (e) {
        console.error(e);
        toast(`削除失敗: ${e.message || e}`);
      }
    }

    async function adjustQty(id, currentQty, delta) {
      const next = currentQty + delta;
      if (next < 1) return toast("数量は1以上（0はNG）");
      await updateItem(id, { quantity: next }, true);
    }

    // ==========
    // Modal
    // ==========
    function openModal(item) {
      editingId = item.id;
      $("mName").value = item.name || "";
      $("mExp").value = item.expiration_date || "";
      $("mQty").value = String(item.quantity ?? 1);
      $("mLoc").value = normalizeLocationFromRow(item) || "";

      const diff = daysDiffFromToday(item.expiration_date);
      const loc = normalizeLocationFromRow(item) || "未設定";
      $("mHint").textContent = `保存場所: ${loc} / 残日数: ${diff < 0 ? (Math.abs(diff) + "日 期限切れ") : (diff === 0 ? "今日まで" : ("あと" + diff + "日"))}`;

      $("modalBackdrop").classList.add("show");
      $("modalBackdrop").setAttribute("aria-hidden", "false");
      modalOpen = true;
    }

    function closeModal() {
      $("modalBackdrop").classList.remove("show");
      $("modalBackdrop").setAttribute("aria-hidden", "true");
      modalOpen = false;
      editingId = null;
    }

    // ==========
    // Render
    // ==========
    function getFilteredAndSorted() {
      const q = $("inSearch").value.trim().toLowerCase();

      let list = itemsCache;

      // location tab filter
      if (activeLoc !== TAB_ALL) {
        list = list.filter(it => normalizeLocationFromRow(it) === activeLoc);
      }

      // search by name
      if (q) {
        list = list.filter(it => (it.name || "").toLowerCase().includes(q));
      }

      // sorting
      const sort = getSortSpec();
      if (sort.kind === "practice") {
        list = sortPractice(list);
      }
      return list;
    }

    function renderKpi(list) {
      $("kpiTotal").textContent = String(list.length);
      let soon = 0;
      let expired = 0;
      for (const it of list) {
        const d = daysDiffFromToday(it.expiration_date);
        if (d < 0) expired++;
        if (d >= 0 && d <= 3) soon++;
      }
      $("kpiSoon").textContent = String(soon);
      $("kpiExpired").textContent = String(expired);
    }

    function render() {
      const listEl = $("list");
      listEl.innerHTML = "";

      const list = getFilteredAndSorted();
      renderKpi(list);
      $("empty").style.display = list.length ? "none" : "block";

      for (const it of list) {
        const diff = daysDiffFromToday(it.expiration_date);
        const cls = badgeClass(diff);
        const loc = normalizeLocationFromRow(it) || "（未設定）";

        const card = document.createElement("div");
        card.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = it.name;

        const meta = document.createElement("div");
        meta.className = "meta";

        const pLoc = document.createElement("div");
        pLoc.className = "pill";
        pLoc.textContent = `保存場所: ${loc}`;

        const p1 = document.createElement("div");
        p1.className = `pill ${cls}`;
        p1.textContent = `賞味期限: ${it.expiration_date}`;

        const p2 = document.createElement("div");
        p2.className = "pill";
        if (diff < 0) p2.textContent = `${Math.abs(diff)}日 期限切れ`;
        else if (diff === 0) p2.textContent = "今日まで";
        else p2.textContent = `あと${diff}日`;

        meta.appendChild(pLoc);
        meta.appendChild(p1);
        meta.appendChild(p2);

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "right";

        // stepper
        const step = document.createElement("div");
        step.className = "stepper";

        const btnMinus = document.createElement("button");
        btnMinus.type = "button";
        btnMinus.className = "secondary";
        btnMinus.textContent = "－";
        btnMinus.onclick = () => adjustQty(it.id, it.quantity, -1);

        const qty = document.createElement("div");
        qty.className = "qty";
        qty.textContent = String(it.quantity);

        const btnPlus = document.createElement("button");
        btnPlus.type = "button";
        btnPlus.className = "secondary";
        btnPlus.textContent = "＋";
        btnPlus.onclick = () => adjustQty(it.id, it.quantity, +1);

        step.appendChild(btnMinus);
        step.appendChild(qty);
        step.appendChild(btnPlus);

        const btnEdit = document.createElement("button");
        btnEdit.type = "button";
        btnEdit.className = "secondary";
        btnEdit.textContent = "編集";
        btnEdit.onclick = () => openModal(it);

        right.appendChild(step);
        right.appendChild(btnEdit);

        card.appendChild(left);
        card.appendChild(right);
        listEl.appendChild(card);
      }
    }

    // ==========
    // Events / Init
    // ==========
    $("btnSaveCfg").addEventListener("click", () => {
      saveCfgToLS();
      refreshSessionUI();
    });

    $("btnLogin").addEventListener("click", login);
    $("btnLogout").addEventListener("click", logout);
    $("btnAdd").addEventListener("click", addItem);

    $("btnReload").addEventListener("click", () => reloadItems(true));
    $("selSort").addEventListener("change", () => render()); // practiceはJSなので再描画でOK
    $("inSearch").addEventListener("input", render);

    $("password").addEventListener("keydown", (e) => {
      if (e.key === "Enter") login();
    });

    // modal interactions
    $("modalBackdrop").addEventListener("click", (e) => {
      if (e.target === $("modalBackdrop")) closeModal();
    });
    document.addEventListener("keydown", (e) => {
      if (modalOpen && e.key === "Escape") closeModal();
    });
    $("mCancel").addEventListener("click", closeModal);

    $("mSave").addEventListener("click", async () => {
      if (!editingId) return;

      const name = $("mName").value.trim();
      const exp = $("mExp").value;
      const qty = parseInt($("mQty").value, 10);
      const loc = $("mLoc").value.trim();

      const msg = validateItem(name, exp, qty, loc);
      if (msg) return toast(msg);

      await updateItem(editingId, {
        name,
        expiration_date: exp,
        quantity: qty,
        note: loc
      });
      closeModal();
    });

    $("mDelete").addEventListener("click", async () => {
      if (!editingId) return;
      await deleteItem(editingId);
    });

    // init defaults
    $("inExp").value = formatDateYMD(new Date());
    $("selSort").value = "exp_practice";

    loadCfgFromLS();
    setLibStatus();
    buildTabs();

    (async () => {
      if (($("sbUrl").value || "").trim() && ($("sbKey").value || "").trim()) {
        ensureSupabase();
      }
      try {
        await refreshSessionUI();
      } catch (e) {
        console.error(e);
        toast(`初期化失敗: ${e.message || e}`);
      }

      const sb = ensureSupabase();
      if (sb) {
        sb.auth.onAuthStateChange(async () => {
          await refreshSessionUI();
        });
      }
    })();
  </script>
</body>
</html>
